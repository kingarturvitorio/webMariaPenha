<!-- templates/mapa.html -->
{% extends "app/base_site.html" %}

{% load static %}

{% block content %}
<div class="right_col" role="main">
    <div class="">
        <div class="title_left">


            <h1>Mapa com Captura de Coordenadas</h1>
            <div id="map" style="height: 500px;"></div>
        </div>
    </div>
</div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicializando o mapa
        var map = L.map('map').setView([-23.55052, -46.633308], 13);

        // Adicionando o tile layer do mapa (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Evento de clique no mapa para capturar coordenadas
        map.on('click', function (e) {
            var latitude = e.latlng.lat;
            var longitude = e.latlng.lng;

            alert("Coordenadas: " + latitude + ", " + longitude);

            fetch('http://3.20.168.85:8000/api/v1/ocorrencias/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoyMDM5NDY5MzkxLCJpYXQiOjE3MjQxMDkzOTEsImp0aSI6IjkzMjQ2ZGFlMTYyNjQ3MjJiNDNjNTg5ZjkzMGE2ZDdmIiwidXNlcl9pZCI6MX0.02gNxQL4v1RPRCA_Gwfkuf0G0vVI4axYQYoTekuJ7Z0',  // Token Bearer
                    'X-CSRFToken': '{{ csrf_token }}'  // Inclua o CSRF token se a API for interna e exigir isso
                },
                body: JSON.stringify({
                    latocorr: latitude,
                    longocorr: longitude,
                    nivelocorrencia: '1',
                    datahora: '2024-08-07',
                    status: '1',
                    link: 'Rua',
                    solicitante: '1'
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Resposta da API:', data);
                })
                .catch((error) => {
                    console.error('Erro:', error);
                });
        });
    });
</script>
{% endblock %}
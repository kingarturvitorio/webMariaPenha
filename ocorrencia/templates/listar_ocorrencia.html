{% extends "app/base_site.html" %}
{% load static %}

{% block content %}
<div class="right_col" role="main">
  <div class="">
    <div class="title_left">
      <div class="row">
        <div class="car-grid">

          {# Primeira linha: Ocorrências de Prioridade Alta #}
          <h3>Ocorrências de Prioridade Alta</h3>
          <div class="priority-high">
            {% for ocorrencia in ocorrencias %}
              {% if ocorrencia.nivelocorrencia == 3 %}
                <div class="car-card {{ ocorrencia.css_class }}" 
                     data-lat="{{ ocorrencia.latocorr|floatformat:5 }}"
                     data-long="{{ ocorrencia.longocorr|floatformat:5 }}">
                  <h2>{{ ocorrencia.solicitante_nome }}</h2>
                  <h2>{{ ocorrencia.datahora }}</h2>
                  <h2>{{ ocorrencia.latocorr }}</h2>
                  <h2>{{ ocorrencia.longocorr }}</h2>
                  <!-- Botões para abrir mapa e WebSocket -->
                  <button onclick="openMapPopup('{{ ocorrencia.latocorr|floatformat:5 }}', '{{ ocorrencia.longocorr|floatformat:5 }}')">Localidade</button>
                  <button onclick="openWebSocketMapPopup('{{ ocorrencia.latocorr|floatformat:5 }}', '{{ ocorrencia.longocorr|floatformat:5 }}')">Tempo Real</button>
                </div>
              {% endif %}
            {% endfor %}
          </div>

          {# Repetir o mesmo para Prioridade Média e Baixa #}
          <h3>Ocorrências de Prioridade Média</h3>
          <div class="priority-medium">
            {% for ocorrencia in ocorrencias %}
              {% if ocorrencia.nivelocorrencia == 2 %}
                <div class="car-card {{ ocorrencia.css_class }}" 
                     data-lat="{{ ocorrencia.latocorr|floatformat:5 }}"
                     data-long="{{ ocorrencia.longocorr|floatformat:5 }}">
                  <h2>{{ ocorrencia.solicitante_nome }}</h2>
                  <h2>{{ ocorrencia.datahora }}</h2>
                  <h2>{{ ocorrencia.latocorr }}</h2>
                  <h2>{{ ocorrencia.longocorr }}</h2>
                  <button onclick="openMapPopup('{{ ocorrencia.latocorr|floatformat:5 }}', '{{ ocorrencia.longocorr|floatformat:5 }}')">Localidade</button>

                </div>
              {% endif %}
            {% endfor %}
          </div>

          <h3>Ocorrências de Prioridade Baixa</h3>
          <div class="priority-low">
            {% for ocorrencia in ocorrencias %}
              {% if ocorrencia.nivelocorrencia == 1 %}
                <div class="car-card {{ ocorrencia.css_class }}" 
                     data-lat="{{ ocorrencia.latocorr|floatformat:5 }}"
                     data-long="{{ ocorrencia.longocorr|floatformat:5 }}">
                  <h2>{{ ocorrencia.solicitante_nome }}</h2>
                  <h2>{{ ocorrencia.datahora }}</h2>
                  <h2>{{ ocorrencia.latocorr }}</h2>
                  <h2>{{ ocorrencia.longocorr }}</h2>
                  <button onclick="openMapPopup('{{ ocorrencia.latocorr|floatformat:5 }}', '{{ ocorrencia.longocorr|floatformat:5 }}')">Localidade</button>
                </div>
              {% endif %}
            {% endfor %}
          </div>

        </div>

        {% if not ocorrencias %}
          <p class="no-results">Nenhuma ocorrência encontrada.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div id="mapModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeMapPopup()">&times;</span>
    <iframe id="mapFrame" width="100%" height="450" frameborder="0" style="border:0" allowfullscreen></iframe>
  </div>
</div>

{# Novo modal para o WebSocket #}
<div id="websocketMapModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeWebSocketMapPopup()">&times;</span>
    <div id="websocketMap" style="width: 100%; height: 450px;"></div> <!-- Contêiner para o mapa do WebSocket -->
  </div>
</div>


<script>

let websocket; // Variável para armazenar a instância do WebSocket
let map; // Variável global para o mapa


  function openWebSocketMapPopup(lat, long) {
    lat = parseFloat(lat.replace(',', '.'));
    long = parseFloat(long.replace(',', '.'));
    console.log("Abrindo WebSocket para coordenadas - Latitude:", lat, "Longitude:", long);

  // Se o mapa já estiver inicializado, não o inicialize novamente
  if (!map) {
      // Inicializa o mapa no novo modal com o nível de zoom ajustado
      map = L.map('websocketMap').setView([lat, long], 30); // Ajuste o nível de zoom aqui, por exemplo, 15

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
      }).addTo(map);
  } else {
      // Se o mapa já existir, apenas atualize sua posição
      map.setView([lat, long], 30);
  }

  // Adiciona ou atualiza o marcador
  let marker = L.marker([lat, long]).addTo(map);

  // Conecte-se ao WebSocket
  websocket = new WebSocket('ws://3.20.168.85:8000/ws/gps/');

  websocket.onopen = function() {
      console.log("Conexão WebSocket aberta.");
      // Envie as coordenadas iniciais
      websocket.send(JSON.stringify({ latitude: lat, longitude: long }));
  };

  websocket.onmessage = function(event) {
      console.log("Mensagem recebida:", event.data);
      const data = JSON.parse(event.data); // Supondo que a mensagem seja um JSON
      // Atualiza a posição do marcador e do mapa
      marker.setLatLng([data.latitude, data.longitude]);
      map.setView([data.latitude, data.longitude], 15); // Atualiza a visualização do mapa
  };

  websocket.onclose = function() {
      console.log("Conexão WebSocket fechada.");
  };

  websocket.onerror = function(error) {
      console.error("Erro WebSocket:", error);
  };

  // Mostra o novo modal do WebSocket
  document.getElementById('websocketMapModal').style.display = 'block';

  // Força o mapa a recalcular seu tamanho
  setTimeout(function() {
      if (map) {
          map.invalidateSize(); // Recalcula as dimensões do mapa
      }
  }, 500); // Um pequeno atraso pode ajudar, ajuste conforme necessário
}

// Função para fechar o modal do WebSocket e encerrar a conexão
function closeWebSocketMapPopup() {
    document.getElementById('websocketMapModal').style.display = 'none';
    if (websocket) {
        websocket.close(); // Encerra a conexão WebSocket
        websocket = null; // Limpa a variável
    }
    if (map) {
        // Se necessário, você pode redefinir o mapa ou remover o marcador aqui
        // Mas, por enquanto, apenas deixamos o mapa como está
    }
}
</script>
{% endblock %}
